@using System.Globalization
@using Jamper_Financial.Shared.Data
@using Jamper_Financial.Shared.Utilities
@using Jamper_Financial.Shared.Models
@using Jamper_Financial.Shared.Services

@if (ShowFilterDropdown)
{
    <div class="filter-modal" @onclick="OnCloseFilterDropdown">
        <div class="filter-modal-content" @onclick:stopPropagation="true">
            <h3>Filter Transactions</h3>
            <div class="filter-form-group">
                <label for="filterCategory">Category:</label>
                <select id="filterCategory" @bind="Filter.Category">
                    <option value="">All</option>
                    @foreach (var category in Categories)
                    {
                        <option value="@category.CategoryID">@category.Name</option>
                    }
                </select>
            </div>
            <div class="filter-form-group amount-filter">
                <div>
                    <label for="minAmount">Min Amount:</label>
                    <input id="minAmount" type="number" @bind="Filter.MinAmount" />
                </div>
                <div>
                    <label for="maxAmount">Max Amount:</label>
                    <input id="maxAmount" type="number" @bind="Filter.MaxAmount" />
                </div>
            </div>
            <div class="filter-form-group date-filter">
                <div>
                    <label for="firstDate">Start Date:</label>
                    <input id="firstDate" type="date" @bind="Filter.StartDate" format="yyyy-MM-dd" />
                </div>
                <div>
                    <label for="secondDate">End Date:</label>
                    <input id="secondDate" type="date" @bind="Filter.EndDate" format="yyyy-MM-dd" />
                </div>
            </div>
            <div class="filter-form-group">
                <label for="accountId">Account:</label>
                <select id="accountId" @bind="Filter.AccountId">
                    <option value="">All</option>
                    @foreach (var account in Accounts)
                    {
                        <option value="@account.AccountId">@account.AccountName</option>
                    }
                </select>
            </div>
            <div class="filter-form-group">
                <label for="frequency">Frequency:</label>
                <select id="frequency" @bind="Filter.Frequency">
                    <option value="">All</option>
                    <option value="None">None</option>
                    <option value="Monthly">Monthly</option>
                    <option value="Yearly">Yearly</option>
                </select>
            </div>
            <div class="filter-form-group">
                <label for="hasEndDate">Has End Date:</label>
                <select id="hasEndDate" @bind="HasEndDateString">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="filter-form-group">
                <label for="hasReceipt">Has Receipt:</label>
                <select id="hasReceipt" @bind="HasReceiptString">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="filter-form-group">
                <label for="isPaid">Is Paid:</label>
                <select id="isPaid" @bind="IsPaidString">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="filter-form-group button-group">
                <button type="button" class="reset" @onclick="ResetFilters">Reset</button>
                <button type="button" class="cancel" @onclick="OnCloseFilterDropdown">Cancel</button>
                <button type="button" class="apply" @onclick="ApplyFilters">Apply</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool ShowFilterDropdown { get; set; }
    [Parameter] public List<Category> Categories { get; set; }
    [Parameter] public List<BankAccount> Accounts { get; set; }
    [Parameter] public List<Transaction> Transactions { get; set; }
    [Parameter] public EventCallback<List<Transaction>> OnFilteredTransactionsChanged { get; set; }
    [Parameter] public EventCallback OnCloseFilterDropdown { get; set; }

    [Parameter] public Filter CurrentFilter { get; set; } = new Filter();

    private Filter Filter { get; set; } = new Filter();

    private string HasEndDateString
    {
        get => Filter.HasEndDate?.ToString() ?? string.Empty;
        set => Filter.HasEndDate = string.IsNullOrEmpty(value) ? null : bool.Parse(value);
    }

    private string HasReceiptString
    {
        get => Filter.HasReceipt?.ToString() ?? string.Empty;
        set => Filter.HasReceipt = string.IsNullOrEmpty(value) ? null : bool.Parse(value);
    }

    private string IsPaidString
    {
        get => Filter.IsPaid?.ToString() ?? string.Empty;
        set => Filter.IsPaid = string.IsNullOrEmpty(value) ? null : bool.Parse(value);
    }

    protected override void OnParametersSet()
    {
        Filter = CurrentFilter;
        base.OnParametersSet();
    }

    private void ApplyFilters()
    {
        var filteredTransactions = FilterUtilities.ApplyFilters(Transactions, Filter);
        OnFilteredTransactionsChanged.InvokeAsync(filteredTransactions);
        OnCloseFilterDropdown.InvokeAsync();
    }

    private void ResetFilters()
    {
        Filter = new Filter();
    }
}
