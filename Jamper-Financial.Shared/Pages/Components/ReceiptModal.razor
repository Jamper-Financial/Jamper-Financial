@using Jamper_Financial.Shared.Data;
@using Jamper_Financial.Shared.Utilities;
@using Jamper_Financial.Shared.Pages.Components;
@using Microsoft.AspNetCore.Components.Forms;
@using Jamper_Financial.Shared.Models;
@inject IJSRuntime JSRuntime

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> OnClose { get; set; }
    [Parameter] public Transaction Transaction { get; set; }
    private IBrowserFile? uploadedFile;
    private string? receiptPreviewUrl;
    private bool showDeleteConfirmation = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (Transaction.HasReceipt == true)
        {
            Console.WriteLine("Transaction has receipt " + Transaction.HasReceipt);
            await GetReceipt();
        }
    }

    // Inject the TransactionManager service
    private void CloseModal()
    {
        OnClose.InvokeAsync(false);
    }

    // This method is called when the Save button is clicked
    private async Task SaveReceipt()
    {
        if (uploadedFile == null)
        {
            errorMessage = "Please select a file before saving.";
            return;
        }

        if (Transaction != null && uploadedFile != null)
        {
            Console.WriteLine("Saving receipt...");

            // Implement the logic to save the receipt
            Transaction.HasReceipt = true;
            if (await TransactionManager.UpdateReceiptAsync(Transaction, uploadedFile))
            {
                toasterMessage = "Receipt added successfully!";
                toasterClass = "success";
                await GetReceipt();
                errorMessage = null;
            }
            else
            {
                errorMessage = "Failed to save receipt.";
            }
        }
    }

    private async Task GetReceipt()
    {
        Console.WriteLine("Displaying receipt");
        var receiptData = await TransactionHelper.GetReceiptAsync(Transaction.TransactionID);
        if (receiptData != null)
        {
            receiptPreviewUrl = $"data:image/png;base64,{Convert.ToBase64String(receiptData.ReceiptFileData)}";
        }
    }

    private async Task OpenReceiptInNewTab()
    {
        if (receiptPreviewUrl != null)
        {
            await JSRuntime.InvokeVoidAsync("openInNewTab", receiptPreviewUrl);
        }
    }

    // This method is called when a file is selected
    private Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        errorMessage = null;
        return Task.CompletedTask;
    }

    private void ShowDeleteConfirmation()
    {
        showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        showDeleteConfirmation = false;
    }

    private async Task DeleteReceipt()
    {
        if (Transaction != null)
        {
            Console.WriteLine("Deleting receipt...");
            await TransactionHelper.DeleteReceiptAsync(Transaction.TransactionID);
            Transaction.HasReceipt = false;
            receiptPreviewUrl = null;
            uploadedFile = null;
            showDeleteConfirmation = false;
        }
    }
}

@if (IsVisible)
{
    <div class="modal" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Receipt Details</h3>
            <p><strong>Description:</strong> @Transaction.Description</p>
            <p><strong>Transaction ID:</strong> @Transaction.TransactionID</p>
            <p><strong>Category:</strong> @Transaction.CategoryID</p>
            <p><strong>Date:</strong> @Transaction.Date.ToString("dd MMM, hh:mm tt")</p>
            <p><strong>Amount:</strong> @((Transaction.Debit > 0 ? Transaction.Debit : Transaction.Credit).ToString("C"))</p>
            @if (Transaction.HasReceipt == true)
            {
                <p>Receipt is available.</p>
                @if (receiptPreviewUrl != null)
                {
                    <img src="@receiptPreviewUrl" alt="Receipt" style="max-width: 100%;" @onclick="OpenReceiptInNewTab" />
                }
                <div class="button-container">
                    <button class="delete-button" @onclick="ShowDeleteConfirmation">Delete Receipt</button>
                </div>
            }
            else
            {
                <p>No receipt available.</p>
                <InputFile OnChange="HandleFileSelected" />
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <p></p>
                    <p class="error-message">@errorMessage</p>
                }
                <div class="button-container">
                    <button class="save-button" @onclick=" SaveReceipt">Save</button>
                    <button class="delete-button" @onclick="CloseModal">Cancel</button>
                </div>
            }
        </div>
    </div>
}

@if (showDeleteConfirmation)
{
    <div class="modal" @onclick="HideDeleteConfirmation">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this receipt?</p>
            <div class="button-container">
                <button class="save-button" @onclick="DeleteReceipt">Yes</button>
                <button class="delete-button" @onclick="HideDeleteConfirmation">No</button>
            </div>
        </div>
}