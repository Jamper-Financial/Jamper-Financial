@page "/dashboard-page"
@inherits LayoutComponentBase
@using Jamper_Financial.Shared.Data
@using Jamper_Financial.Shared.Services
@using Jamper_Financial.Shared.Models
@inject NavigationManager Navigation
@inject IUserService UserService
@inject LoginStateService LoginState
@inject UserStateService UserStateService


@code {
    [CascadingParameter] private Action<string> SetPageTitle { get; set; }

    private UserProfile userProfile = new UserProfile();
    private int currentIndex = 0;
    private List<string> cards = new List<string> { "History", "Recent Transactions", "Manage Saving Goals" };

    protected override async Task OnInitializedAsync()
    {
        SetPageTitle("Dashboard");



        // Get the logged-in user's ID and username from the UserStateService
        int userId = UserStateService.UserId;
        string username = UserStateService.Username;

        Console.WriteLine(userId);

        if (userId > 0)
        {
            userProfile = await UserService.GetUserProfileByIdAsync(userId);
        }
        else
        {
            Navigation.NavigateTo("/login");
        }
    }

<<<<<<< Updated upstream
=======
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RenderHistoryChart();
            await RenderSavingGoalsChart();
            await RenderWeeklyChart();
            isChartRendered = true;
        }
    }

    private async Task RenderWeeklyChart()
    {
        var daysOfWeek = new[] { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };
        var expenseData = new decimal[7];
        var salaryData = new decimal[7];

        foreach (var expense in weeklyExpenses)
        {
            var dayOfWeek = (int)expense.Date.DayOfWeek;
            expenseData[dayOfWeek] += expense.ExpenseAmount;
            salaryData[dayOfWeek] += expense.SalaryAmount;
        }

        var chartData = new
        {
            labels = daysOfWeek,
            datasets = new[]
            {
                new
                {
                    label = "Expenses",
                    data = expenseData,
                    backgroundColor = "rgba(75, 192, 192, 0.2)",
                    borderColor = "rgba(75, 192, 192, 1)",
                    borderWidth = 1,
                    borderRadius = 0
                },
                new
                {
                    label = "Salary",
                    data = salaryData,
                    backgroundColor = "rgba(153, 102, 255, 0.2)",
                    borderColor = "rgba(153, 102, 255, 1)",
                    borderWidth = 1 ,
                    borderRadius = 10
                }
            }
        };
        await JS.InvokeVoidAsync("initializeBarChart", "weeklyActivityChart", chartData);
    }

    private async Task RenderHistoryChart()
    {
        var months = new[] { "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" };
        var incomeData = new decimal[12];
        var expenseData = new decimal[12];
        var differenceData = new decimal[12];

        foreach (var expense in monthlyExpenses)
        {
            var month = expense.Date.Month - 1; // Month is 1-based, array is 0-based
            expenseData[month] += expense.ExpenseAmount;
            incomeData[month] += expense.SalaryAmount;
        }

        for (int i = 0; i < 12; i++)
        {
            differenceData[i] = incomeData[i] - expenseData[i];
        }

        var chartData = new
        {
            labels = months,
            datasets = new[]
            {
            new
            {
                label = "Total Income - Expenses",
                data = differenceData,
                backgroundColor = "rgba(75, 192, 192, 0.2)",
                borderColor = "rgba(75, 192, 192, 1)",
                // fill = "origin",
                // borderWidth = 1,
                // borderRadius = 0,
                // fill = {
                //     target: "origin",
                //     above: "rgb(255, 0, 0)",   Area will be red above the origin
                //     below: "rgb(0, 0, 255)"   And blue below the origin
                //     },
                // lineTension = 0.5
            }
        }
        };
        await JS.InvokeVoidAsync("initializeLineChart", "HistoryChart", chartData);
    }


    private async Task RenderSavingGoalsChart()
    {
        var daysOfWeek = new[] { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };
        var expenseData = new decimal[7];
        var salaryData = new decimal[7];

        foreach (var expense in weeklyExpenses)
        {
            var dayOfWeek = (int)expense.Date.DayOfWeek;
            expenseData[dayOfWeek] += expense.ExpenseAmount;
            salaryData[dayOfWeek] += expense.SalaryAmount;
        }

        var chartData = new
        {
            labels = daysOfWeek,
            datasets = new[]
            {
                new
                {
                    label = "Expenses",
                    data = expenseData,
                    backgroundColor = "rgba(75, 192, 192, 0.2)",
                    borderColor = "rgba(75, 192, 192, 1)",
                    borderWidth = 1,
                    borderRadius = 0
                },
                new
                {
                    label = "Salary",
                    data = salaryData,
                    backgroundColor = "rgba(153, 102, 255, 0.2)",
                    borderColor = "rgba(153, 102, 255, 1)",
                    borderWidth = 1 ,
                    borderRadius = 10
                }
            }
        };
        await JS.InvokeVoidAsync("initializeBarChart", "SavingsGoalsChart", chartData);
    }

>>>>>>> Stashed changes
    private void NextCard()
    {
        currentIndex = (currentIndex + 1) % cards.Count;
    }

    private void NavigateToSavingGoals()
    {
        Navigation.NavigateTo("/view-goals-page");
    }
}

<div class="dashboard-container">
    <div class="dashboard-header">
        <h3>Welcome back to JAMPER Finance!</h3>
    </div>

    <!-- Carousel Section -->
    <div class="carousel">
        <div class="card">
            <h3 class="@(cards[currentIndex] == "Manage Saving Goals" ? "manage-saving-goals-header" : "")" 
                @onclick="@(() => { if (cards[currentIndex] == "Manage Saving Goals") NavigateToSavingGoals(); })">
                @cards[currentIndex]
            </h3>
        </div>
        <div class="card">
            <h3 class="@(cards[(currentIndex + 1) % cards.Count] == "Manage Saving Goals" ? "manage-saving-goals-header" : "")" 
                @onclick="@(() => { if (cards[(currentIndex + 1) % cards.Count] == "Manage Saving Goals") NavigateToSavingGoals(); })">
                @cards[(currentIndex + 1) % cards.Count]
            </h3>
        </div>
        <button class="carousel-button" @onclick="NextCard">&#10095;</button>
    </div>

    <!-- Weekly Activity Section -->
    <div class="weekly-activity">
        <h4>Weekly Activity</h4>
        <div class="card">Placeholder for weekly activities...</div>
    </div>
</div>