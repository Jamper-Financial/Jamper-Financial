@inherits LayoutComponentBase
@using Jamper_Financial.Shared.Services
@inject NavigationManager Navigation
@inject UserStateService UserStateService
@inject ISessionRepository SessionRepository
@inject IJSRuntime JSRuntime
@inject HttpClient Http

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <button class="navbar-toggler header-toggle-button" @onclick="ToggleMenu" />
        <a class="navbar-brand" href="dashboard-page">Jamper Financial</a>
    </div>
</div>

@* <input type="checkbox" title="Navigation menu" class="navbar-toggler" /> *@

@* <div class="" onclick="const toggler = document.querySelector('.navbar-toggler'); if (toggler) toggler.click();"> *@
<div>
    <nav class="flex flex-col space-y-4">
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="dashboard-page">
                <img src="images/dashboard-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class="text-lg font-medium font-['Inter']">Dashboard</div>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="transactions-page">
                <img src="images/transactions-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class=" text-lg font-medium font-['Inter']">Transactions</div>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="budget-insights-page">
                <img src="images/budget-insights-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class=" text-lg font-medium font-['Inter']">Budget Insights</div>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="manage-categories">
                <img src="images/budget-insights-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class=" text-lg font-medium font-['Inter']">Manage Categories</div>
            </NavLink>
        </div>
        @*Hide for now as it's part of MVP*@
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="bulk-transactions">
                <img src="images/receipt-management-icon.svg" class="w-6 h-6 " style="padding-right: 6px" />
                <div class="text-lg font-medium font-['Inter']">Bulk Transactions</div>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="saving-goals-page">
                <img src="images/saving-goals-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class=" text-lg font-medium font-['Inter']">Saving Goals</div>
            </NavLink>
        </div>
        @* <div class="nav-item"> *@
        @*     <NavLink class="nav-link flex items-center space-x-2" href="debt-tracking-page"> *@
        @*         <img src="images/debt-tracking-icon.svg" class="w-6 h-6 " style="padding-right: 6px" /> *@
        @*         <div class=" text-lg font-medium font-['Inter']">Debt Tracking</div> *@
        @*     </NavLink> *@
        @* </div> *@
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="calendar-page">
                <img src="images/calendar-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class="text-lg font-medium font-['Inter']">Calendar</div>
            </NavLink>
        </div>
        <div class="nav-item">
            <NavLink class="nav-link flex items-center space-x-2" href="reports-page">
                <img src="images/reports-icon.svg" class="w-6 h-6 nav-icon" style="padding-right: 6px" />
                <div class=" text-lg font-medium font-['Inter']">Reports</div>
            </NavLink>
        </div>
        <div class="nav-item">
            <div class="logout-container">
                <button type="button" class="logout-button" @onclick="Logout">
                    Logout
                </button>
            </div>
            @* <div class=" text-lg font-medium font-['Inter']">Log Out</div> *@
        </div>
    </nav>
</div>

@code {
        [CascadingParameter]
        public EventCallback ToggleMenu { get; set; }
        [CascadingParameter]
        public bool isMenuOpen { get; set; }
    private bool _hasRendered = false;

    private async Task Logout() // Change to async Task
    {
        Console.WriteLine("Logout button clicked.");
        try
        {
            // Call the API endpoint to handle session deletion and cookie clearing
            var response = await Http.PostAsync("/api/auth/logout", null); // Use PostAsync or similar

            if (!response.IsSuccessStatusCode)
            {
                // Log an error if the API call fails, but proceed with client-side cleanup
                Console.Error.WriteLine($"Logout API call failed with status: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            // Log any exception during the API call
            Console.Error.WriteLine($"Error calling logout API: {ex.Message}");
        }
        finally // Ensure client-side cleanup happens even if API call fails
        {
            // Clear user session state (if used for UI)
            UserStateService.ClearUser();

            // Navigate to the login page
            Navigation.NavigateTo("/login", forceLoad: true); // Force load might be good after logout
        }
    }
}

